trigger:
  branches:
    include:
      - master

variables:
- group: test
- name: AWS_PRIVATE_IP
  value: '172.31.23.70'

stages:
- stage: PreRequisites
  displayName: 'Pre-requisites'
  jobs:
  - job: PreReqJob
    displayName: 'Prepare the EC2 Instance'
    pool:
      name: 'aws ec2'
      demands:
        - agent.name -equals cicd
    steps:
    - script: |
        mkdir -p ~/.ssh
        echo "$SSH_KEY" | tr -d '\r' > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H $(AWS_PRIVATE_IP) >> ~/.ssh/known_hosts
      displayName: 'Setup SSH Key'
      env:
        SSH_KEY: $(SSH_KEY)

    - script: |
        ssh -o StrictHostKeyChecking=no ubuntu@$(AWS_PRIVATE_IP) << 'EOF'
          rm -rf /home/ubuntu/Udemy-section*
          git clone https://baljeets1790@dev.azure.com/baljeets1790/Course-section8-main/_git/Course-section8-main
          cd Course-section8-main
          chmod 744 build.sh
          chmod 744 deploy.sh
        EOF
      displayName: 'Run Pre-Requisites'

- stage: Build
  dependsOn: PreRequisites
  jobs:
  - job: BuildJob
    displayName: 'Run Build Script on EC2'
    pool:
      name: 'aws ec2'
      demands:
        - agent.name -equals cicd
    steps:
    - script: |
        mkdir -p ~/.ssh
        echo "$SSH_KEY" | tr -d '\r' > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H $(AWS_PRIVATE_IP) >> ~/.ssh/known_hosts
      displayName: 'Setup SSH Key'
      env:
        SSH_KEY: $(SSH_KEY)

    - script: |
        ssh -o StrictHostKeyChecking=no ubuntu@$(AWS_PRIVATE_IP) "bash /home/ubuntu/Course-section8-main/build.sh"
      displayName: 'Build App'

- stage: Deploy
  dependsOn: Build
  jobs:
  - job: DeployJob
    displayName: 'Run Deploy Script on EC2'
    pool:
      name: 'aws ec2'
      demands:
        - agent.name -equals cicd
    steps:
    - script: |
        mkdir -p ~/.ssh
        echo "$SSH_KEY" | tr -d '\r' > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H $(AWS_PRIVATE_IP) >> ~/.ssh/known_hosts
      displayName: 'Setup SSH Key'
      env:
        SSH_KEY: $(SSH_KEY)

    - script: |
        ssh -o StrictHostKeyChecking=no ubuntu@$(AWS_PRIVATE_IP) "bash /home/ubuntu/Course-section8-main/deploy.sh"
      displayName: 'Deploy App'


###Manual approaval####
# - stage: Deploy
#   dependsOn: Build
#   jobs:
#   - deployment: DeployJob
#     displayName: 'Run Deploy Script on EC2'
#     environment: test
#     pool:
#       name: 'aws ec2'
#       demands:
#         - agent.name -equals cicd
#     strategy:
#       runOnce:
#         deploy:
#           steps:
#             - script: |
#                 mkdir -p ~/.ssh
#                 echo "$SSH_key" | tr -d '\r' > ~/.ssh/id_rsa
#                 chmod 600 ~/.ssh/id_rsa
#                 ssh-keyscan -H $(AWS_PRIVATE_IP) >> ~/.ssh/known_hosts
#               displayName: 'Setup SSH Key'
#               env:
#                 SSH_key: $(SSH_key)

#             - script: |
#                 ssh -o StrictHostKeyChecking=no ubuntu@$(AWS_PRIVATE_IP) "bash /home/ubuntu/sagar2/deploy.sh"
#               displayName: 'Deploy App'

